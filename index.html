<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASC Pent치gono Diagn칩stico</title>
    <!-- Incluir Chart.js desde CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --color-primary: #0C4A6E; /* Azul Oscuro (Sky-900) */
            --color-secondary: #059669; /* Verde (Emerald-600) */
            --color-background: #f8fafc; /* Gris muy claro (Slate-50) */
            --color-card-bg: #ffffff;
            --color-text: #1e293b; /* Gris oscuro (Slate-800) */
            --color-text-muted: #64748b; /* Gris medio (Slate-500) */
            --border-radius: 0.5rem;
            --box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --icon-color: var(--color-primary);
        }
        body { font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: var(--color-background); color: var(--color-text); margin: 0; padding: 0; line-height: 1.6; }
        .container { max-width: 1024px; margin: 0 auto; padding: 1rem 2rem; }
        .hero { text-align: center; padding: 4rem 1rem; background-color: var(--color-primary); color: white; margin-bottom: 3rem; }
        .hero h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.75rem; }
        .logo-svg { width: 40px; height: 40px; stroke: currentColor; stroke-width: 1.5; fill: none; }
        .logo-img { width: 40px; height: 40px; object-fit: contain; }
        .footer-logo-img { width: 120px; height: 120px; object-fit: contain; margin-bottom: 0.5rem; }
        .hero p { font-size: 1.125rem; max-width: 700px; margin: 0 auto; opacity: 0.9; }
        .grid { display: grid; gap: 1.5rem; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        @media (min-width: 768px) { .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
        @media (min-width: 1024px) { .lg\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
        .card-container-5 { display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
        .card { background-color: var(--color-card-bg); border-radius: var(--border-radius); padding: 1.5rem; box-shadow: var(--box-shadow); transition: transform 0.2s ease-in-out; display: flex; flex-direction: column; }
        .card:hover { transform: translateY(-5px); }
        .card h3 { margin-top: 0; color: var(--color-primary); font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem; }
        .card-icon-svg { width: 24px; height: 24px; stroke: var(--icon-color); stroke-width: 1.5; fill:none; flex-shrink: 0; }
        .card h3 span { background-color: var(--color-secondary); color: white; font-size: 0.75rem; padding: 0.1rem 0.4rem; border-radius: 0.25rem; margin-left: auto; font-weight: 600; }
        .card p { color: var(--color-text-muted); font-size: 0.9rem; flex-grow: 1; }
        .form-section { background-color: var(--color-card-bg); padding: 2rem; border-radius: var(--border-radius); box-shadow: var(--box-shadow); margin-top: 3rem; }
        .form-section h2 { text-align: center; margin-bottom: 2rem; font-size: 1.8rem; color: var(--color-primary); }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--color-text); }
        .form-group input[type="text"], .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; box-sizing: border-box; font-family: inherit; }
        .form-group textarea { min-height: 150px; resize: vertical; }
        small { display: block; font-size: 0.8rem; color: var(--color-text-muted); margin-top: 0.25rem; }
        .question-block { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb; }
        .question-block p { margin-bottom: 0.75rem; font-weight: 500; }
        .radio-group { display: flex; flex-wrap: wrap; gap: 0.5rem 1rem; align-items: center; }
        .radio-group label { display: flex; align-items: center; gap: 0.3rem; font-weight: 400; cursor: pointer; font-size: 0.9rem; }
        .radio-group input[type="radio"] { cursor: pointer; accent-color: var(--color-primary); }
        .btn { display: inline-flex; align-items: center; justify-content: center; background-color: var(--color-primary); color: white; padding: 0.8rem 1.8rem; border: none; border-radius: var(--border-radius); font-size: 1rem; font-weight: 600; text-align: center; cursor: pointer; transition: background-color 0.2s ease; margin-top: 1rem; width: 100%; }
        .btn-spinner { position: relative; gap: 0.5rem; align-items: center; }
        .antialiased { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .btn-spinner.loading { background-color: var(--color-secondary); }
        .btn-download { background-color: var(--color-secondary); padding: 0.6rem 1.2rem; margin-left: auto; }
        .btn-download:hover:not(:disabled) { background-color: #059669; }
        .report-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 2.5rem; flex-wrap: wrap; gap: 1rem; }
        @media (min-width: 640px) { .btn { width: auto; } }
        .btn:hover:not(:disabled) { background-color: #082f49; /* Sky-950 */ }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        #reportSection { display: none; margin-top: 3rem; padding: 2rem; background-color: var(--color-card-bg); border-radius: var(--border-radius); box-shadow: var(--box-shadow); }
        #reportSection h2 { text-align: center; color: var(--color-primary); margin-bottom: 2.5rem; }
        .report-layout { display: flex; flex-direction: column; gap: 2.5rem; }
        .report-chart-area { order: 1; }
        .report-feedback-area { order: 2; }
        @media (min-width: 1024px) { .report-layout { flex-direction: row; align-items: flex-start;} .report-chart-area { flex: 1 1 40%; max-width: 450px; margin: 0 auto; position: sticky; top: 2rem;} .report-feedback-area { flex: 1 1 60%; } }
        .chart-container { position: relative; margin: 0 auto; padding: 1rem; border: 1px solid #eee; border-radius: var(--border-radius); background-color: #f8fafc; }
        #radarChart { max-width: 100%; height: auto; }
        .feedback-section h3 { margin-top: 2rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem; font-size: 1.8rem; font-weight: 800; }

        /* Estilo especial para el Diagn칩stico General */
        .feedback-section h2.diagnostico-general {
            margin-top: 3rem;
            margin-bottom: 1rem;
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, #0C4A6E, #0369A1);
            color: white;
            border-radius: 12px;
            font-size: 1.6rem;
            font-weight: 800;
            text-align: center;
            box-shadow: 0 8px 25px rgba(12, 74, 110, 0.3);
            position: relative;
        }

        .feedback-section p.diagnostico-general-note {
            text-align: center;
            font-style: italic;
            color: var(--color-text-muted);
            font-size: 1.1rem;
            margin-bottom: 2rem;
            padding: 0.5rem;
            background-color: rgba(12, 74, 110, 0.05);
            border-radius: 8px;
            border-left: 4px solid var(--color-primary);
        }

        /* Estilos espec칤ficos para cada principio */
        .feedback-section .principle-title-cope { color: #059669 /* Verde emerald */; border-bottom: 4px solid #10b981; padding-bottom: 0.75rem; }
        .feedback-section .principle-title-part { color: #7c3aed /* Violeta */; border-bottom: 4px solid #8b5cf6; padding-bottom: 0.75rem; }
        .feedback-section .principle-title-diin { color: #dc2626 /* Rojo */; border-bottom: 4px solid #ef4444; padding-bottom: 0.75rem; }
        .feedback-section .principle-title-imtr { color: #ea580c /* Naranja */; border-bottom: 4px solid #f97316; padding-bottom: 0.75rem; }
        .feedback-section .principle-title-arcr { color: #0891b2 /* Cyan */; border-bottom: 4px solid #06b6d4; padding-bottom: 0.75rem; }

        .feedback-section .principle-title-cope .principle-icon { width: 48px; height: 48px; stroke: #059669; fill: none; stroke-width: 2; }
        .feedback-section .principle-title-part .principle-icon { width: 48px; height: 48px; stroke: #7c3aed; fill: none; stroke-width: 2; }
        .feedback-section .principle-title-diin .principle-icon { width: 48px; height: 48px; stroke: #dc2626; fill: none; stroke-width: 2; }
        .feedback-section .principle-title-imtr .principle-icon { width: 48px; height: 48px; stroke: #ea580c; fill: none; stroke-width: 2; }
        .feedback-section .principle-title-arcr .principle-icon { width: 48px; height: 48px; stroke: #0891b2; fill: none; stroke-width: 2; }

        .feedback-section .score-badge { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 0.5rem 1rem; border-radius: 2rem; font-size: 1.1rem; font-weight: 700; box-shadow: 0 4px 10px rgba(0,0,0,0.15); margin-left: auto; }
        .vector-icon-svg-report { width: 20px; height: 20px; stroke: var(--color-secondary); stroke-width: 1.5; fill:none; flex-shrink: 0; }
        .feedback-section p, .feedback-section li, .feedback-section strong, .feedback-section h4 { font-size: 0.95rem; line-height: 1.7; color: var(--color-text-muted); margin-bottom: 1rem; }
        .feedback-section strong { color: var(--color-text); font-weight: 600; }
        .feedback-section h4 { color: #e11d48; /* Un color distinctivo rosa-rojo para H4 */ margin-top: 1.5rem; font-size: 1.3rem; font-weight: 700; }
        .feedback-section ul { list-style: disc; padding-left: 1.5rem; }
        .loading-message, .error-message { text-align: center; padding: 1rem; margin-top: 1rem; border-radius: var(--border-radius); }
        .loading-message { color: var(--color-primary); background-color: rgba(12, 74, 110, 0.1); }
        .error-message { color: #b91c1c; /* Red-700 */ background-color: rgba(185, 28, 28, 0.1); }
        footer { text-align: center; margin-top: 4rem; padding: 2rem 1rem; color: var(--color-text-muted); font-size: 0.875rem; border-top: 1px solid #e5e7eb; }
        .text-center { text-align: center; }

        /* Spinner de carga */
        .spinner { width: 1rem; height: 1rem; border: 2px solid rgba(12, 74, 110, 0.3); border-top: 2px solid var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .btn-spinner { position: relative; }
        .btn-spinner:disabled { background-color: var(--color-primary); }
        .btn-spinner.disabled { opacity: 0.6; cursor: not-allowed; }
    </style>
</head>
<body>
    <header class="hero">
        <div class="container">
             <h1>
             <svg class="logo-svg" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
             ASC Pent치gono Diagn칩stico
             </h1>
            <p>Una herramienta alineada con la Pol칤tica P칰blica de Minciencias para diagnosticar y fortalecer la Apropiaci칩n Social del Conocimiento en tus proyectos.</p>
        </div>
    </header>
    <main class="container">
        <section id="vectors">
            <h2 class="text-center mb-4" style="font-size: 1.8rem; color: var(--color-primary);">Los 5 Principios de la Apropiaci칩n Social</h2>
             <div class="card-container-5">
                <div class="card">
                    <h3><svg class="card-icon-svg" viewBox="0 0 24 24"><circle cx="12" cy="10" r="3"/><path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 6.9 8 11.7z"/></svg>Contexto y Pertinencia <span>COPE</span></h3>
                    <p>Capacidad del proyecto para adaptarse a las realidades locales, necesidades y caracter칤sticas culturales del territorio.</p>
                </div>
                 <div class="card">
                    <h3><svg class="card-icon-svg" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Participaci칩n Activa <span>PART</span></h3>
                    <p>Nivel y calidad de la intervenci칩n ciudadana en la toma de decisiones, colaboraci칩n y gobernanza del proyecto.</p>
                </div>
                 <div class="card">
                    <h3><svg class="card-icon-svg" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><path d="M13 8H7"/><path d="M17 12H7"/></svg>Di치logo de Saberes <span>DIIN</span></h3>
                    <p>Creaci칩n de espacios equitativos para intercambiar y construir conocimiento entre saberes cient칤ficos, locales y tradicionales.</p>
                </div>
                 <div class="card">
                    <h3><svg class="card-icon-svg" viewBox="0 0 24 24"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/><path d="m13 13-1-4-4 1 1 4 4-1z"/></svg>Impacto y Transformaci칩n<span>IMTR</span></h3>
                    <p>Capacidad para generar cambios y resultados concretos como producto de la participaci칩n y el di치logo colaborativo.</p>
                </div>
                 <div class="card">
                    <h3><svg class="card-icon-svg" viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>Reflexi칩n Cr칤tica<span>ARCR</span></h3>
                    <p>Procesos de an치lisis continuo, evaluaci칩n y sistematizaci칩n de experiencias para el aprendizaje y la mejora constante.</p>
                </div>
            </div>
        </section>
        <section id="diagnosis-form" class="form-section">
             <h2>Realiza tu Diagn칩stico</h2>
             <form id="ascForm">
                 <div class="form-group"><label for="projectName">Nombre del Proyecto / Organizaci칩n:</label><input type="text" id="projectName" name="projectName" required></div>
                 <div class="form-group"><label for="projectDescription">Describe tu proyecto (Contexto, objetivos, p칰blico, etc.):</label><textarea id="projectDescription" name="projectDescription" rows="6" placeholder="Proporciona detalles sobre tu proyecto para ayudar a la IA a generar recomendaciones m치s precisas (hasta 5000 caracteres)." maxlength="5000" required></textarea><small>Esta descripci칩n se usar치 para contextualizar el an치lisis de la IA.</small></div>
                 <div id="questionsContainer"></div>
                 <div class="text-center mt-8"><button type="submit" id="submitButton" class="btn btn-spinner"><span class="antialiased">Generar Diagn칩stico con IA</span><div class="spinner" id="submitSpinner" style="display: none;"></div></button></div>
                  <div id="loadingIndicator" class="loading-message" style="display: none;">Generando reporte con IA... Esto puede tardar unos segundos.</div>
                  <div id="errorIndicator" class="error-message" style="display: none;"></div>
             </form>
        </section>
        <section id="reportSection">
              <div class="report-header">
                  <h2 id="reportTitle">Reporte de Diagn칩stico ASC</h2>
                  <button id="downloadReportBtn" class="btn btn-download">Descargar</button>
              </div>
             <div class="report-layout">
                 <div class="report-chart-area"><div class="chart-container"><canvas id="radarChart"></canvas></div></div>
                 <div class="report-feedback-area"><div class="feedback-section" id="feedbackContainer"><p>Completa el formulario para generar tu diagn칩stico y recomendaciones personalizadas.</p></div></div>
             </div>
        </section>
    </main>
    <footer>
        <div class="container">
            <img src="https://ia601206.us.archive.org/32/items/ccfjc-logo-color/CCFJC%20Logo%20Color%20.png" alt="CCFJC Logo" class="footer-logo-img">
            <p>Desarrollado en el Makerspace del Centro de Ciencia Francisco Jos칠 de Caldas</p>
        </div>
    </footer>
    <script>
        const questions = [
            { vector: 'COPE', text: '1. 쮼l proyecto parti칩 de un diagn칩stico participativo para identificar y comprender las realidades, intereses y problemas del contexto local donde se desarrolla?' }, { vector: 'COPE', text: '2. 쯃as soluciones o alternativas que propone el proyecto son pertinentes, oportunas y respetuosas con las caracter칤sticas culturales, sociales y ambientales del territorio?' }, { vector: 'COPE', text: '3. 쮼l proyecto cuenta con mecanismos para adaptarse a cambios en el contexto o a nuevas necesidades identificadas por los participantes durante su ejecuci칩n?' }, { vector: 'COPE', text: '4. 쮼l proyecto considera y se articula con los planes de desarrollo y pol칤ticas p칰blicas locales, regionales o nacionales relevantes para su 치rea de acci칩n?' }, { vector: 'COPE', text: '5. 쯉e han identificado y mapeado los diferentes actores sociales del territorio para comprender sus roles, relaciones e intereses en torno al proyecto?' },
            { vector: 'PART', text: '6. 쮼l proyecto fomenta la participaci칩n activa de la ciudadan칤a en la toma de decisiones clave (ej. definici칩n de objetivos, metodolog칤as, asignaci칩n de recursos)?' }, { vector: 'PART', text: '7. 쯉e implementan convocatorias abiertas o estrategias de comunicaci칩n inclusivas para invitar a diversos actores sociales a vincularse al proyecto?' }, { vector: 'PART', text: '8. 쮼l proyecto promueve la creaci칩n y fortalecimiento de espacios (mesas de trabajo, comit칠s, talleres) donde la comunidad puede participar activamente en el dise침o y gesti칩n de las iniciativas?' }, { vector: 'PART', text: '9. 쮼xisten roles definidos y se promueve el liderazgo de los miembros de la comunidad dentro de la estructura y gobernanza del proyecto?' }, { vector: 'PART', text: '10. 쯉e generan alianzas con otras organizaciones (instituciones educativas, gobiernos locales, sector privado) para fortalecer los procesos de participaci칩n ciudadana?' },
            { vector: 'DIIN', text: '11. 쮼l proyecto dise침a y facilita activamente espacios para el encuentro y el di치logo respetuoso entre el conocimiento cient칤fico-tecnol칩gico y los saberes tradicionales, locales o ancestrales?' }, { vector: 'DIIN', text: '12. 쯃os resultados y productos del proyecto (informes, materiales, etc.) integran y reflejan la diversidad de saberes y perspectivas de los participantes?' }, { vector: 'DIIN', text: '13. 쮼l proyecto utiliza metodolog칤as participativas (ej. cartograf칤a social, talleres de co-creaci칩n) que facilitan el intercambio y la construcci칩n conjunta de conocimiento?' }, { vector: 'DIIN', text: '14. 쯉e fomenta el di치logo entre investigadores y la ciudadan칤a para la generaci칩n y uso del conocimiento, en l칤nea con principios de ciencia ciudadana o ciencia abierta?' }, { vector: 'DIIN', text: '15. 쯉e promueve el intercambio de experiencias y aprendizajes con otros proyectos o comunidades para enriquecer el conocimiento colectivo?' },
            { vector: 'IMTR', text: '16. 쮼l proyecto genera resultados tangibles (productos, servicios, metodolog칤as, pol칤ticas) que contribuyen a la transformaci칩n de las realidades o problemas identificados inicialmente?' }, { vector: 'IMTR', text: '17. 쮼l proyecto fortalece las capacidades de los actores sociales para que puedan gestionar, producir o aplicar conocimiento de forma aut칩noma en el futuro?' }, { vector: 'IMTR', text: '18. 쯃os procesos de co-creaci칩n del proyecto han resultado en la construcci칩n de relaciones m치s horizontales y de confianza entre los diversos actores involucrados?' }, { vector: 'IMTR', text: '19. 쮼l proyecto cuenta con indicadores para medir el impacto de sus procesos y resultados en el bienestar de la comunidad o en la soluci칩n de la problem치tica abordada?' }, { vector: 'IMTR', text: '20. 쯃os resultados del proyecto son sistematizados y comunicados de forma que puedan ser replicados, escalados o apropiados por otros actores o en otros contextos?' },
            { vector: 'ARCR', text: '21. 쮼l proyecto implementa procesos continuos de seguimiento y monitoreo para analizar sus avances y desaf칤os, involucrando la perspectiva de los participantes?' }, { vector: 'ARCR', text: '22. 쯉e realizan ejercicios de sistematizaci칩n de experiencias para documentar los aprendizajes, tanto los 칠xitos como las dificultades del proceso?' }, { vector: 'ARCR', text: '23. 쮼l proyecto fomenta espacios de reflexi칩n cr칤tica entre los participantes para analizar sus pr치cticas, las condiciones de su contexto y las transformaciones logradas?' }, { vector: 'ARCR', text: '24. 쯉e realiza una evaluaci칩n de resultados (ex-post) que permite evidenciar los avances en el cumplimiento de los objetivos y las necesidades de ajuste?' }, { vector: 'ARCR', text: '25. 쯃os aprendizajes generados a partir de la evaluaci칩n y la reflexi칩n cr칤tica se utilizan para mejorar el dise침o de futuras fases o nuevos proyectos?' }
        ];
        const questionsContainer = document.getElementById('questionsContainer');
        const vectors = ['COPE', 'PART', 'DIIN', 'IMTR', 'ARCR'];
        const vectorNames = { COPE: 'Contexto y Pertinencia', PART: 'Participaci칩n Activa', DIIN: 'Di치logo de Saberes', IMTR: 'Impacto y Transformaci칩n', ARCR: 'Reflexi칩n Cr칤tica' };
        const vectorIconsSVG = {
             COPE: '<svg class="vector-icon-svg-report" viewBox="0 0 24 24"><circle cx="12" cy="10" r="3"/><path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 6.9 8 11.7z"/></svg>',
             PART: '<svg class="vector-icon-svg-report" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
             DIIN: '<svg class="vector-icon-svg-report" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><path d="M13 8H7"/><path d="M17 12H7"/></svg>',
             IMTR: '<svg class="vector-icon-svg-report" viewBox="0 0 24 24"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/><path d="m13 13-1-4-4 1 1 4 4-1z"/></svg>',
             ARCR: '<svg class="vector-icon-svg-report" viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>'
        };
        // L칩gica para poblar preguntas (igual que antes, adaptada a 5 vectores)
        vectors.forEach(vector => {
            console.log("Procesando vector:", vector);
            const vectorTitle = document.createElement('h3');
            vectorTitle.innerHTML = `<span style="flex-shrink:0;">${vectorIconsSVG[vector].replace('vector-icon-svg-report', 'card-icon-svg')}</span>${vectorNames[vector]}`;
            vectorTitle.style.color = 'var(--color-primary)'; vectorTitle.style.marginTop = '2rem'; vectorTitle.style.borderBottom = '1px solid #eee'; vectorTitle.style.paddingBottom = '0.5rem'; vectorTitle.style.display = 'flex'; vectorTitle.style.alignItems = 'center'; vectorTitle.style.gap = '0.5rem';
            questionsContainer.appendChild(vectorTitle);
            questions.filter(q => q.vector === vector).forEach(q => {
                const qBlock = document.createElement('div'); qBlock.className = 'question-block';
                const qIndex = questions.indexOf(q);
                qBlock.innerHTML = `<p>${q.text}</p>`;
                const rGroup = document.createElement('div'); rGroup.className = 'radio-group';
                for (let i = 1; i <= 5; i++) {
                    let labelText = '';
                    switch(i) { case 1: labelText = '1 (Bajo/Nunca)'; break; case 2: labelText = '2'; break; case 3: labelText = '3 (Medio)'; break; case 4: labelText = '4'; break; case 5: labelText = '5 (Alto/Siempre)'; break; }
                    rGroup.innerHTML += `<label><input type="radio" name="q${qIndex}" value="${i}" required> ${labelText}</label>`;
                }
                qBlock.appendChild(rGroup);
                questionsContainer.appendChild(qBlock);
            });
        });

        // L칩gica de formulario, API y reporte (igual que antes, adaptada a 5 vectores)
        const form = document.getElementById('ascForm');
        const reportSection = document.getElementById('reportSection');
        const feedbackContainer = document.getElementById('feedbackContainer');
        const reportTitle = document.getElementById('reportTitle');
        const submitButton = document.getElementById('submitButton');
        const submitSpinner = document.getElementById('submitSpinner');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorIndicator = document.getElementById('errorIndicator');
        const downloadReportBtn = document.getElementById('downloadReportBtn');
        const ctx = document.getElementById('radarChart').getContext('2d');
        let radarChartInstance = null;
        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            submitButton.disabled = true; submitButton.classList.add('loading'); submitSpinner.style.display = 'inline-block'; loadingIndicator.style.display = 'block'; errorIndicator.style.display = 'none'; reportSection.style.display = 'none';
            const projectName = document.getElementById('projectName').value;
            const projectDescription = document.getElementById('projectDescription').value;
            const scores = { COPE: [], PART: [], DIIN: [], IMTR: [], ARCR: [] };
            let allAnswered = true;
            questions.forEach((q, index) => {
                const selected = document.querySelector(`input[name="q${index}"]:checked`);
                if (selected) { scores[q.vector].push(parseInt(selected.value)); } else { allAnswered = false; }
            });
            if (!allAnswered) { showError("Por favor, responde todas las preguntas."); return; }
            const averageScores = {};
            vectors.forEach(v => { averageScores[v] = parseFloat((scores[v].reduce((a, b) => a + b, 0) / scores[v].length).toFixed(1)); });
            const apiPayload = { projectName, projectDescription, scores: averageScores };
            try {
                const response = await fetch('/api/diagnose', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(apiPayload) });
                if (!response.ok) { let eMsg = `Error: ${response.status}`; try { const eData = await response.json(); eMsg = eData.error || eMsg; } catch (e) {} throw new Error(eMsg); }
                const result = await response.json();
                displayReport(projectName, averageScores, result.diagnosisText || "An치lisis no disponible.");
            } catch (error) { console.error("Error API:", error); showError(`Error al generar diagn칩stico: ${error.message}.`);
            } finally { loadingIndicator.style.display = 'none'; submitSpinner.style.display = 'none'; submitButton.disabled = false; submitButton.classList.remove('loading'); }
        });
        function displayReport(name, scoresData, feedbackText) {
            reportSection.style.display = 'block'; reportTitle.textContent = `Reporte de Diagn칩stico ASC para: ${name}`;

            console.log("=== PROCESANDO REPORTE ===");

            // Guardar las puntuaciones en localStorage para usar en PDF
            Object.keys(scoresData).forEach(vector => {
                localStorage.setItem(`score_${vector}`, scoresData[vector].toString());
            });
            // Procesar t칤tulos principales de Gemini primero - m치s robusto
            let processedFeedback = feedbackText.replace(/^##\s+(.+)(?:\r?\n|$)/gm, '<h2>$1</h2>');
            processedFeedback = processedFeedback.replace(/^###\s+(.+)(?:\r?\n|$)/gm, (match, title) => {
                let vectorKey = Object.keys(vectorNames).find(key => title.includes(vectorNames[key]) || title.includes(`(${key})`));
                if (vectorKey) {
                    let score = scoresData[vectorKey] || 'X.X';
                    let expandedIcon = vectorIconsSVG[vectorKey].replace('vector-icon-svg-report', 'principle-icon');
                    let className = `principle-title-${vectorKey.toLowerCase()}`;
                    let scoreBadge = `<span class="score-badge">${score}/5</span>`;
                    return `<h3 class="${className}">${expandedIcon}<span>${vectorNames[vectorKey]}</span>${scoreBadge}</h3>`;
                }
                return `<h3>${title.trim()}</h3>`;
            });
            processedFeedback = processedFeedback.replace(/^####\s+(.+)(?:\r?\n|$)/gm, '<h4>$1</h4>');

            // Procesar secciones diagn칩stico y recomendaciones con prioridad espec칤fica
            // Primero asegurar que "Diagn칩stico General" se mantenga como H2
            processedFeedback = processedFeedback.replace(/\*\*Diagn칩stico General\*\*/gi, '<h2 class="diagnostico-general">Diagn칩stico General</h2>');
            processedFeedback = processedFeedback.replace(/\*\*Diagn칩stico Espec칤fico\*\*/gi, '<h4>Diagn칩stico Espec칤fico</h4>');
            processedFeedback = processedFeedback.replace(/\*\*Recomendaciones Accionables\*\*/gi, '<h4 class="recomendaciones-accionables">Recomendaciones Accionables</h4>');

            // Agregar una nota explicativa despu칠s del t칤tulo principal
            processedFeedback = processedFeedback.replace(/(<h2 class="diagnostico-general">Diagn칩stico General<\/h2>)/g, '$1<p class="diagnostico-general-note">An치lisis integral del perfil ASC del proyecto basado en su descripci칩n y evaluaci칩n de los 5 principios</p>');

            // Procesar otras secciones gen칠ricas en negrita que no sean las espec칤ficas ya procesadas
            processedFeedback = processedFeedback.replace(/\*\*([A-Z][a-z].*?)\*\*/g, match => {
                const text = match.replace(/\*\*/g, '').trim();
                // Solo procesar si no est치 ya convertido y no es un principio ya procesado
                if (!text.includes('<h2') && !text.includes('<h4') && !text.includes('<h3') &&
                    !Object.values(vectorNames).some(name => text.includes(name))) {
                    if (text.includes('Diagn칩stico') && !text.includes('Diagn칩stico General')) {
                        return `<h4>${text}</h4>`;
                    }
                    if (text.includes('Recomendaciones') && !text.includes('Recomendaciones Accionables')) {
                        return `<h4>${text}</h4>`;
                    }
                    // Solo convertir si realmente es un t칤tulo (may칰scula al inicio)
                    if (text.length > 5 && /^[A-Z]/.test(text)) {
                        return `<h3>${text}</h3>`;
                    }
                }
                return match; // Dejar intacto si ya est치 convertido
            });

            // Procesar formatos markdown est치ndar como fallback
            processedFeedback = processedFeedback.replace(/## DIAGN칍STICO GENERAL/g, '<h2 class="diagnostico-general">游댌 DIAGN칍STICO GENERAL</h2>');
            processedFeedback = processedFeedback.replace(/### DIAGN칍STICO GENERAL/g, '<h2 class="diagnostico-general">游댌 DIAGN칍STICO GENERAL</h2>');

            // Procesar listas con guiones, asteriscos o puntos - m치s flexible
            processedFeedback = processedFeedback.replace(/^[\s]*[-*+]\s+(.*?)(?:\r?\n|$)/gm, '<li>$1</li>');
            processedFeedback = processedFeedback.replace(/^[\s]*\d+\.\s+(.*?)(?:\r?\n|$)/gm, '<li>$1</li>');

            // Procesar negritas que no sean t칤tulos
            processedFeedback = processedFeedback.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // Reemplazar saltos de l칤nea con breaks
            processedFeedback = processedFeedback.replace(/\n/g, '<br>');

            // Mejorar el wrapping de listas - convertir grupos consecutivos de li en ul
            processedFeedback = processedFeedback.replace(/(<li>.*?<\/li><br>\s*)+(?=<br>|<\/|$)/g, (match) => '<ul>' + match + '</ul>');
            // Limpiar breaks extra en listas
            processedFeedback = processedFeedback.replace(/(<\/ul><br>)+/g, '</ul>');

            // Procesar p치rrafos - dividir el contenido en p치rrafos cuando haya multiples l칤neas en blanco
            processedFeedback = processedFeedback.replace(/(?:<br><\/item>\s*)+/g, '</p><p>');
            processedFeedback = processedFeedback.replace(/^(<br>*)/, '<p>');
            processedFeedback = processedFeedback.replace(/(<br>*)$/, '</p>');

            // Debug: Mostrar el contenido procesado
            console.log("Contenido procesado final:", processedFeedback);

            feedbackContainer.innerHTML = processedFeedback;
            const chartData = { labels: vectors.map(v => vectorNames[v]), datasets: [{ label: `Diagn칩stico ASC`, data: vectors.map(v => scoresData[v]), backgroundColor: 'rgba(12, 74, 110, 0.2)', borderColor: 'rgba(12, 74, 110, 1)', borderWidth: 2, pointBackgroundColor: 'rgba(12, 74, 110, 1)', pointBorderColor: '#fff' }] };
            const chartOptions = { scales: { r: { angleLines: { color: 'rgba(0, 0, 0, 0.1)' }, suggestedMin: 0, suggestedMax: 5, grid: { color: 'rgba(0, 0, 0, 0.1)' }, pointLabels: { font: { size: 12 }, color: '#333' }, ticks: { stepSize: 1, backdropColor: 'rgba(255, 255, 255, 0.75)' } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => `${ctx.parsed.r.toFixed(1)} / 5` } } } };
            if (radarChartInstance) radarChartInstance.destroy();
            radarChartInstance = new Chart(ctx, { type: 'radar', data: chartData, options: chartOptions });
            reportSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        function showError(message) { errorIndicator.textContent = message; errorIndicator.style.display = 'block'; submitSpinner.style.display = 'none'; loadingIndicator.style.display = 'none'; submitButton.disabled = false; submitButton.classList.remove('loading'); }

        // Funci칩n para descargar el reporte como archivo HTML autossuficiente
        function downloadReportAsHTML() {
            try {
                const reportTitle = document.getElementById('reportTitle').textContent;
                const projectName = reportTitle.replace("Reporte de Diagn칩stico ASC para: ", "");
                const feedbackContainer = document.getElementById('feedbackContainer');

                // Obtener vectores y puntajes para incluir en HTML
                const vectors = ['COPE', 'PART', 'DIIN', 'IMTR', 'ARCR'];
                const vectorNames = {
                    'COPE': 'Contexto y Pertinencia',
                    'PART': 'Participaci칩n Activa',
                    'DIIN': 'Di치logo de Saberes',
                    'IMTR': 'Impacto y Transformaci칩n',
                    'ARCR': 'Reflexi칩n Cr칤tica'
                };

                // Crear contenido HTML con estilos inline
                const fecha = new Date().toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let htmlContent = `
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte ASC - ${projectName}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            background-color: #0C4A6E;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .project-info {
            margin-bottom: 30px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .scores-table {
            margin-bottom: 30px;
            overflow-x: auto;
        }
        .scores-table table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .scores-table th,
        .scores-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        .scores-table th {
            background-color: #0C4A6E;
            color: white;
            font-weight: 600;
        }
        .feedback-section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .diagnostico-general h2 {
            background: linear-gradient(135deg, #0C4A6E, #0369A1);
            color: white;
            border-radius: 12px;
            font-size: 1.6rem;
            font-weight: 800;
            padding: 1.5rem 2rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        .principle-title-cope {
            color: #059669;
            font-size: 1.8rem;
            font-weight: 800;
            margin: 2rem 0 1rem 0;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .principle-title-part {
            color: #7c3aed;
            font-size: 1.8rem;
            font-weight: 800;
            margin: 2rem 0 1rem 0;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .principle-title-diin {
            color: #dc2626;
            font-size: 1.8rem;
            font-weight: 800;
            margin: 2rem 0 1rem 0;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .principle-title-imtr {
            color: #ea580c;
            font-size: 1.8rem;
            font-weight: 800;
            margin: 2rem 0 1rem 0;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .principle-title-arcr {
            color: #0891b2;
            font-size: 1.8rem;
            font-weight: 800;
            margin: 2rem 0 1rem 0;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .feedback-section h4 {
            color: #e11d48;
            font-size: 1.2rem;
            font-weight: 600;
            margin: 1.5rem 0 1rem 0;
        }
        .feedback-section p {
            font-size: 0.95rem;
            line-height: 1.7;
            color: #64748b;
            margin-bottom: 1rem;
        }
        .feedback-section strong {
            color: #1e293b;
            font-weight: 600;
        }
        .feedback-section ul {
            padding-left: 1.5rem;
            margin: 1rem 0;
        }
        .feedback-section li {
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
            line-height: 1.5;
            color: #64748b;
        }
        .score-badge {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 2rem;
            font-size: 1rem;
            font-weight: 600;
            margin-left: auto;
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
            color: #64748b;
        }
        .footer img {
            max-width: 120px;
            margin-bottom: 10px;
        }
        @media print {
            body {
                background-color: white;
            }
            .feedback-section {
                box-shadow: none;
                border: 1px solid #e2e8f0;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>游댌 ASC Pent치gono Diagn칩stico</h1>
        <p>Reporte de An치lisis Completo</p>
    </div>

    <div class="project-info">
        <p><strong>Proyecto/Organizaci칩n:</strong> ${projectName}</p>
        <p><strong>Fecha de Generaci칩n:</strong> ${fecha}</p>
        <p><strong>An치lisis Realizado por:</strong> IA Gemini (Google)</p>
    </div>

    <div class="scores-table">
        <h3 style="margin-bottom: 15px; color: #0C4A6E;">游늵 Calificaci칩n General por Principios ASC</h3>
        <table>
            <thead>
                <tr>
                    <th>Principio ASC</th>
                    <th>Calificaci칩n</th>
                    <th>Interpretaci칩n</th>
                </tr>
            </thead>
            <tbody>`;

                // Agregar filas de tabla con calificaciones
                vectors.forEach(vector => {
                    const score = parseFloat(localStorage.getItem(`score_${vector}`)) || 0;
                    const scoreText =
                        score >= 4.5 ? 'Excelente' :
                        score >= 3.5 ? 'Muy Bueno' :
                        score >= 2.5 ? 'Regular' :
                        score >= 1.5 ? 'Necesita Mejorar' :
                        'Cr칤tico';
                    htmlContent += `
                <tr>
                    <td>${vectorNames[vector]}</td>
                    <td><strong>${score}/5</strong></td>
                    <td>${scoreText}</td>
                </tr>`;
                });

                htmlContent += `
            </tbody>
        </table>
    </div>

    <div class="feedback-section">
        <h3 style="margin-bottom: 20px; color: #0C4A6E;">游늳 An치lisis Detallado de la IA</h3>`;

                // Copiar todo el contenido del feedback container
                const feedbackContent = feedbackContainer.innerHTML;
                htmlContent += feedbackContent;

                htmlContent += `
    </div>

    <div class="footer">
        <img src="https://ia601206.us.archive.org/32/items/ccfjc-logo-color/CCFJC%20Logo%20Color%20.png" alt="CCFJC Logo">
        <p>Generado por el ASC Pent치gono Diagn칩stico</p>
        <p>Centro de Ciencia Francisco Jos칠 de Caldas - Makerspace</p>
        <p>Pol칤tica P칰blica de Minciencias - Apropiaci칩n Social del Conocimiento</p>
    </div>
</body>
</html>`;

                // Crear y descargar el archivo
                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `reporte-asc-${projectName.replace(/[^a-zA-Z0-9]/g, '_')}-${new Date().toISOString().split('T')[0]}.html`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Limpiar URL de objeto
                URL.revokeObjectURL(link.href);

            } catch (error) {
                console.error('Error al generar el HTML:', error);
                alert('Error al descargar el reporte. Int칠ntalo nuevamente.');
            }
        }

        // Event listener para el bot칩n de descarga
        downloadReportBtn.addEventListener('click', downloadReportAsHTML);
    </script>
</body>
</html>
